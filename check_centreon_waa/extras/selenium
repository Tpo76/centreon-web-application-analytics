#!/bin/bash 

XVFB_DISPLAY=:99
SELENIUM_LIB="/opt/selenium/selenium-server-standalone.jar" 
SELENIUM_PORT=4444 
SELENIUM_LOGDIR="/var/log/selenium" 
SELENIUM_PID="/var/run/selenium.pid" 

case "${1:-''}" in 
    'start') 
        if test -f ${SELENIUM_PID}; then 
            echo "Selenium is already running." 
        else 
            DISPLAY=${XVFB_DISPLAY} java -jar ${SELENIUM_LIB} -port ${SELENIUM_PORT} > ${SELENIUM_LOGDIR}/selenium-output.log 2> ${SELENIUM_LOGDIR}/selenium-error.log & echo $! > ${SELENIUM_PID} 
            echo "Starting Selenium..." 
            error=$? 
            if test $error -gt 0 
            then 
                echo "Error $error! Couldn't start Selenium!" 
            fi 
        fi 
    ;; 
    'stop') 
        if test -f ${SELENIUM_PID}; then 
            echo "Stopping Selenium..." 
            PID=$(cat ${SELENIUM_PID})
            kill -3 $PID 
            if kill -9 $PID; then 
              sleep 2 
              test -f ${SELENIUM_PID} && rm -f ${SELENIUM_PID} 
             else 
               echo "Selenium could not be stopped..." 
             fi 
        else 
            echo "Selenium is not running." 
        fi 
        ;; 
    'restart') 
        if test -f ${SELENIUM_PID} 
        then 
            kill -HUP $(cat ${SELENIUM_PID}) 
            test -f ${SELENIUM_PID} && rm -f ${SELENIUM_PID} 
            sleep 1 
            DISPLAY=${XVFB_DISPLAY} java -jar ${SELENIUM_LIB} -port ${SELENIUM_PORT} > ${SELENIUM_LOGDIR}/selenium-output.log 2> ${SELENIUM_LOGDIR}/selenium-error.log & echo $! > ${SELENIUM_PID} 
            echo "Reload Selenium..." 
        else 
            echo "Selenium isn't running..." 
        fi 
        ;; 
    'status')
        if test -f ${SELENIUM_PID}
        then
            PID=$(cat ${SELENIUM_PID})
            PID_RUNNING=$(ps -eaf | awk '{ print $2 }' | grep "^${PID}$")
            if test -n "${PID_RUNNING}"; then
                echo "Selecnium is running (pid ${PID})"
                exit 0   
            else
                echo "Selenium isn't running..."
                exit 3
            fi
        else
            echo "Selenium isn't running..."
            exit 3
        fi
        ;;
    *)    # no parameter specified 
        echo "Usage: ${SELF} start|stop|restart|status" 
        exit 1 
    ;; 
esac 
